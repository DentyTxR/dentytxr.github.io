@using Microsoft.AspNetCore.Components.WebAssembly.Hosting
@inherits LayoutComponentBase
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IWebAssemblyHostEnvironment AppEnv
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject ghp_app.Services.PageSettingsProvider PageSettingsProvider
@inject ghp_app.Services.SettingsService SettingsService
@inject ghp_app.Services.LoadingService LoadingService
@inject NavigationManager NavigationManager

<MudThemeProvider IsDarkMode="true" Theme="Theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<UpdateAvailableDetector />
<LoadingOverlay />

<MudLayout>
    <MudAppBar Elevation="0" Dense="true">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@(DrawerToggle)" />
        <MudSpacer/>
        <MudButton  StartIcon="@Icons.Material.Filled.Settings" OnClick="ShowPageSettings" Color="Color.Primary" />
    </MudAppBar>
    <MudDrawer @bind-Open="@_drawerOpen" Width="200px" ClipMode="DrawerClipMode.Docked">
        <MudDrawerHeader LinkToIndex>
            <MudText Typo="Typo.h5">Dent App</MudText>
        </MudDrawerHeader>
        <NavMenu />
        <MudSpacer />
        @if (AppEnv.IsDevelopment())
        {
            <MudText>Development</MudText>
        }
    </MudDrawer>
    <MudMainContent>
        <ErrorBoundary @ref=errorBoundary>
            <ChildContent>
                <CascadingValue Value="PageSettingsProvider.CurrentSettings">
                    @Body
                </CascadingValue>
            </ChildContent>
            <ErrorContent Context="Exception">
                @{
                    ErrorService.ShowError(Exception);
                }
            </ErrorContent>
        </ErrorBoundary>
    </MudMainContent>
</MudLayout>

@code {
    private MudTheme Theme = new MudTheme();

    private ErrorBoundary? errorBoundary;
    bool _drawerOpen = true;

    protected override async Task OnInitializedAsync()
    {
        ErrorService.Initialize(Snackbar);
        Theme = await SettingsService.GetThemeAsync();
    }

    protected override void OnParametersSet()
    {
        errorBoundary?.Recover();
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task ShowPageSettings()
    {
        var entries = PageSettingsProvider.CurrentSettings ?? new List<PageSettingEntry>();
        var parameters = new DialogParameters
    {
        { "SettingEntries", entries },
        { "OnSave", EventCallback.Factory.Create(this, SavePageSettingsFromLayout) }
    };
        await DialogService.ShowAsync<GlobalSettingsDialog>("Page Settings", parameters);
    }

    private async Task SavePageSettingsFromLayout()
    {
        if (PageSettingsProvider.SaveSettingsAction is not null)
            await PageSettingsProvider.SaveSettingsAction();
    }
}